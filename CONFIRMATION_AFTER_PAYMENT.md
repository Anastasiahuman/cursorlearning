# Письмо после оплаты: подтверждение + ссылка на чат в Telegram

После успешной оплаты (Stripe) пользователю автоматически уходит письмо с текстом «Вы записаны на интенсив» и ссылкой на чат в Telegram.

## Что уже сделано в коде

- Обработчик **`/api/webhook-stripe`** принимает webhook от Stripe и при событии `checkout.session.completed` отправляет письмо через Resend.

## Шаг 1. Resend (отправка писем)

1. Зарегистрируйся на [resend.com](https://resend.com).
2. В разделе **API Keys** создай ключ, скопируй его.
3. В **Vercel** → проект → **Settings** → **Environment Variables** добавь:
   - **RESEND_API_KEY** — вставь ключ из Resend.
   - **CONFIRMATION_FROM_EMAIL** — с какого адреса слать (например `noreply@твой-домен.com`). Для теста можно оставить `onboarding@resend.dev` (тогда письма придут с пометкой Resend).
   - **TELEGRAM_CHAT_LINK** — ссылка на чат интенсива в Telegram (например `https://t.me/joinchat/xxxxx` или инвайт-ссылка группы).

## Шаг 2. Stripe Webhook

1. Зайди в [Stripe Dashboard](https://dashboard.stripe.com) → **Developers** → **Webhooks**.
2. **Add endpoint**.
3. **Endpoint URL:** `https://твой-домен.vercel.app/api/webhook-stripe` (подставь свой домен из Vercel).
4. **Events to send:** выбери **checkout.session.completed** (или «Select events» и найди это событие).
5. Нажми **Add endpoint**.
6. Открой созданный endpoint и в разделе **Signing secret** нажми **Reveal** и скопируй значение (начинается с `whsec_`).
7. В **Vercel** → **Environment Variables** добавь:
   - **STRIPE_WEBHOOK_SECRET** — вставь этот `whsec_...` секрет.

## Шаг 3. Redeploy

В Vercel сделай **Redeploy** последнего деплоя, чтобы подхватились новые переменные и функция `api/webhook-stripe.js`.

## Проверка

Сделай тестовую оплату (Stripe Test mode) и убедись, что на email плательщика пришло письмо с подтверждением и ссылкой на чат. В Stripe → Webhooks можно смотреть доставку событий и ответ (200 = ок).

## ЮKassa: кастомное сообщение после оплаты

**В личном кабинете ЮKassa нет настройки «кастомное письмо покупателю»** (в отличие от Stripe, где можно задать своё письмо в Payment Link). ЮKassa не даёт редактировать текст уведомления, которое получает плательщик; по 54-ФЗ покупателю может уходить только чек, если он настроен.

**Что можно сделать с уже существующими ссылками на оплату:**

### 1. Страница «спасибо» после оплаты (без письма)

- В ЮKassa при создании платежа указывается **return_url** — куда вернуть пользователя после оплаты.
- Для **готовых ссылок** (типа `yookassa.ru/my/i/xxxxx`) возможность задать return_url зависит от того, как они созданы: через ЛК «Счета» или через API. Если в ЛК есть поле «Ссылка после оплаты» / «URL успеха» — укажи туда свою страницу, например:  
  `https://твой-домен.vercel.app/thanks.html`  
  Тогда после оплаты человек попадёт на твою страницу с текстом «Вы записаны» и ссылкой на чат. Это не письмо, но сообщение он увидит сразу.

- Где искать: [ЮKassa — личный кабинет](https://yookassa.ru/my) → раздел, где создаются/редактируются счета или шаблоны ссылок. Если для твоих ссылок такого поля нет, return_url задаётся только при создании платежа через API (у тебя сейчас оплата идёт по готовой ссылке, без твоего API при создании платежа).

### 2. Письмо с подтверждением и ссылкой на чат

Чтобы после оплаты по ЮKassa покупателю приходило **именно письмо** с кастомным текстом и ссылкой на чат:

- Нужна **интеграция по API**: твой сервер создаёт платёж в ЮKassa (с `return_url` и т.д.), а не готовая ссылка из ЛК.
- В [настройках HTTP-уведомлений](https://yookassa.ru/my/merchant/integration/http-notifications) ЮKassa укажи URL твоего обработчика (webhook).
- На этом URL при событии «платёж успешен» твой код отправляет письмо (например через Resend) с текстом «Вы записаны на интенсив» и ссылкой на чат в Telegram.

То есть «кастомное письмо после оплаты» для ЮKassa делается только через свой backend и webhook, отдельно от готовых ссылок из ЛК.

**Итог:** для уже существующих ссылок ЮKassa можно попробовать задать только **страницу успеха** (return_url), если в настройках этих ссылок/счетов есть такое поле. Встроенной настройки «кастомное письмо покупателю» в ЮKassa нет; письмо — только через свой webhook и отправку с твоего сервера.
